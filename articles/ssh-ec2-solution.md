---
title: "å…¬é–‹éµè¨­å®šãªã—ãƒ»public ipç„¡ã—ãƒ»ãƒãƒ¼ãƒˆé–‹æ”¾ãªã—ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«IAMæ¨©é™ã ã‘ã§sshã§ãã‚‹ã‚ˆã†ã«ã—ãŸ"
emoji: "ğŸ”–"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["aws", "ec2", "ssh"]
published: false
---

> è¿½è¨˜: ã“ã®è¨˜äº‹ã§èª¬æ˜ã—ã¦ã„ã‚‹ä»•çµ„ã¿ã¨å…¨ãåŒã˜å†…å®¹ãŒæ—¢ã«ç´¹ä»‹ã•ã‚Œã¦ã„ã¾ã™ã€‚
> https://qiita.com/sisisin/items/1cb6b79f729f1173eaba
>
> ã¾ãŸã€ã“ã¡ã‚‰ã®æ–¹ã¯æ—¢ã«[golang ã§åŒæ§˜ã® CLI ãƒ„ãƒ¼ãƒ«](https://github.com/youyo/awssh)ã‚’å®Ÿè£…ã•ã‚Œã¦ã„ã¾ã™ã€‚
> https://blog.youyo.io/posts/created-awssh-command-that-can-login-to-ec2-instance-securely/
>
> `ssh_ec2`ã¯è–„ã„ shell script ã§ã‚ã‚Šè»½é‡ã§ä¾å­˜ãŒå°‘ãªãæ”¹å¤‰å¯èƒ½ãªã“ã¨ã€ProxyCommand ã«æŒ‡å®šã™ã‚‹ã“ã¨ã§é€šå¸¸ã® ssh ã‚³ãƒãƒ³ãƒ‰ã¨çµ±åˆã—ã¦ä½¿ç”¨ã§ãã‚‹ã“ã¨ãŒæ–°è¦æ€§ã§ã™ã€‚

# TL;DR

ã‚­ãƒ¼ãƒšã‚¢ãƒ»SSH å…¬é–‹éµè¨­å®šã—ã¦ãªãã¦ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã‚µãƒ–ãƒãƒƒãƒˆã«ã‚ã£ã¦ãƒãƒ¼ãƒˆé–‹æ”¾ã‚‚ã—ã¦ãªã„ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã« IAM æ¨©é™ã ã‘ã§ ssh ã§ãã‚‹ä»•çµ„ã¿ã‚’æ€ã„ã¤ã„ãŸã®ã§ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£åŒ–ã—ã¾ã—ãŸã€‚
ãŸã ã®è¶…è–„ã„ shellscript ãªã®ã§é©å½“ã«ã‚³ãƒ”ãƒšã—ã¦æ”¹å¤‰ã—ã¦ä½¿ã£ã¦ã‚‚ OK ã§ã™ã€‚
https://github.com/moajo/ssh_ec2

# ä½¿ã„æ–¹

`ssh_ec2` ã¯ãŸã ã® shellscript ãªã®ã§ã€é©å½“ã« PATH ã®é€šã‚‹å ´æ‰€ã«é…ç½®ã™ã‚Œã° OK ã§ã™ã€‚

åŸºæœ¬çš„ã«ã¯`.ssh/config`ã«ä»¥ä¸‹ã®ã‚ˆã†ã«è¨­å®šã—ã¦ãŠãã ã‘ã§ä½¿ãˆã¾ã™ã€‚

```
host i-* mi-*
    ProxyCommand sh -c "ssh_ec2 %r %h --send-key-only && aws ssm start-session --target %h --document-name AWS-StartSSHSession --parameters 'portNumber=%p'"
```

(ã¡ãªã¿ã«`%r`ã¯ã‚ã¾ã‚Šä½¿ã‚ã‚Œã¦ã„ã‚‹ã¨ã“ã‚ã‚’è¦‹ã¾ã›ã‚“ãŒã€`sshã—ã‚ˆã†ã¨ã—ã¦ã„ã‚‹ãƒ¦ãƒ¼ã‚¶å`ãŒå±•é–‹ã•ã‚Œã¾ã™ã€‚)

ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«æ¥ç¶šã§ãã¾ã™ã€‚

```sh
# ssh [ãƒ¦ãƒ¼ã‚¶å]@[ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ID]
ssh ec2-user@i-xxxxxxx
```

ç°¡å˜ï¼ï¼

æœ€æ–°ã® ubuntu server ã® AMI ã‚’ãã®ã¾ã¾èµ·å‹•ã—ãŸã‚‰ã™ãã« ssh ã§ãã¾ã™ã€‚
äº‹å‰ã«ã‚­ãƒ¼ãƒšã‚¢ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ããŸã‚Šã€é€†ã«å…¬é–‹éµã‚’ç™»éŒ²ã—ãŸã‚Šã™ã‚‹å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
ãƒãƒ¼ãƒˆã®é–‹æ”¾ã‚‚ public ip ã‚¢ãƒ‰ãƒ¬ã‚¹ã®è¨­å®šã‚‚ä¸è¦ã§ã™ã€‚

---

æ—¢ã« SessionManager ã‚’ä½¿ã£ã¦ã„ã¦`.ssh/config`ã‚’æ›¸ãæ›ãˆãŸããªã„ã‚ˆã†ãªã‚±ãƒ¼ã‚¹ã‚‚ã‚ã‚‹ã¨æ€ã„ã¾ã™ã€‚
ãã®å ´åˆã¯`.ssh/config`ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«ã—ãŸã¾ã¾

```
host i-* mi-*
    ProxyCommand sh -c "aws ssm start-session --target %h --document-name AWS-StartSSHSession --parameters 'portNumber=%p'"
```

`ssh`ã®ä»£ã‚ã‚Šã«`ssh_ec2`ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ã„ã¾ã™

```sh
# ssh_ec2 [ãƒ¦ãƒ¼ã‚¶å] [ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ID]
ssh_ec2 ec2-user i-xxxxxxx
```

(@ãŒãªããªã£ã¦ã‚‹ã®ã¯å¼•æ•°ã®ãƒ‘ãƒ¼ã‚¹ãŒé¢å€’ã ã£ãŸã‹ã‚‰ã§ã™ãƒ»ãƒ»ãƒ»ã™ã„ã¾ã›ã‚“ãƒ»ãƒ»ãƒ»:pray:)

(`--send-key-only` ã‚’å¤–ã™ã¨ã€ã‚­ãƒ¼ã‚’è»¢é€ã—ãŸã‚ã¨è¿½åŠ ã§ `ssh "$USER_NAME@$INSTANCE_ID"` ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚)

# ä½•ãŒå¬‰ã—ã„ã‹

EC2 ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã« ssh ã™ã‚‹ã¨ãã¯ã€é€šå¸¸ãã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ public ã‚µãƒ–ãƒãƒƒãƒˆã«ç½®ãã‹ã€ã•ã‚‚ãªã‘ã‚Œã°è¸ã¿å°ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ç¢ºä¿ã—ã¦ãŠãå¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
ã—ã‹ã—ã€ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ public ã‚µãƒ–ãƒãƒƒãƒˆã«ç½®ãã“ã¨ã¯ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¸Šã®ãƒªã‚¹ã‚¯è¦å› ã§ã‚ã‚Šã€æœ€ä½é™ã«ã—ãŸã„ã‚‚ã®ã§ã™ã€‚
ã¾ãŸã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—ã§ã¯ ssh ã«ä½¿ã†(ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ 22 ç•ª)ãƒãƒ¼ãƒˆã‚’é–‹æ”¾ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ãŒã€ã“ã®ç‚¹ã‚‚ sshd ã®è¨­å®šãŒè„†å¼±ã ã¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒªã‚¹ã‚¯ã«ãªã‚Šã¾ã™ã€‚ã§ãã‚Œã°ãƒãƒ¼ãƒˆã‚‚é–‹æ”¾ã—ãŸããªã„ã§ã™ã‚ˆã­ï¼Ÿ
æ›´ã«ã€ã‚­ãƒ¼ãƒšã‚¢ã®ç®¡ç†ã¯éå¸¸ã«é¢å€’ã§ã‚ã‚Šã€ã—ã°ã—ã°ç®¡ç†è€…ã‹ã‚‰ DM ã§éµã‚’é€ã£ã¦ã‚‚ã‚‰ã†ç­‰ã®äººåŠ›ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã«ä¾å­˜ã—ã¦ã„ã¾ã™ã€‚æ­£ç›´ã‚„ã‚ŠãŸããªã„ã§ã™ã€‚

ã“ã®ãƒ„ãƒ¼ãƒ«ã‚’ä½¿ã†ã¨ã“ã®ã‚ãŸã‚Šã®å•é¡ŒãŒ**å…¨éƒ¨**è§£æ±ºã—ã¾ã™ã€‚

# ä»•çµ„ã¿

### SessionManager

https://docs.aws.amazon.com/ja_jp/systems-manager/latest/userguide/session-manager.html
AWS ã«ã¯[SSM SessionManager](https://docs.aws.amazon.com/ja_jp/systems-manager/latest/userguide/session-manager.html)ã¨ã„ã†ã‚µãƒ¼ãƒ“ã‚¹ãŒã‚ã‚Šã¾ã™ã€‚
ã“ã‚Œã¯ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹å†…ã« SSM ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’ç«‹ã¦ã¦ãŠãã¨ã€ãƒãƒ¼ãƒˆé–‹æ”¾ç­‰ã—ã¦ã„ãªãã¦ã‚‚ SSM ã® API ã‹ã‚‰ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å¼µã‚‹ã“ã¨ãŒã§ãã‚‹ã‚‚ã®ã§ã™ã€‚(SSM ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯æœ€æ–°ã® ubuntu/AmazonLinux ã® AMI ã«ã¯æœ€åˆã‹ã‚‰å…¥ã£ã¦ã„ã¾ã™)
ã¾ãŸã€ [SSM ã§ãƒˆãƒ³ãƒãƒ«ã‚’ä½œã£ã¦ãã®ä¸­ã§ SSH ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™](https://docs.aws.amazon.com/systems-manager/latest/userguide/session-manager-getting-started-enable-ssh-connections.html)ã€‚
ã“ã‚Œã‚’ä½¿ã†ã¨ã€ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ private subnet ã«é…ç½®ã—ã¦ãƒãƒ¼ãƒˆã‚’é–‰ã˜ãŸçŠ¶æ…‹ã§ã‚‚ã€ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã« ssh ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚
ã“ã®ã¨ãã®æ¨©é™ã¯ IAM ã§ç®¡ç†ã§ãã‚‹(`ssm:StartSession`ã‚’è¨±å¯ã™ã‚Œã°ã„ã„)ã®ã§ã€é€šå¸¸ã® ssh ã‚ˆã‚Šã‚‚å®‰å…¨ãªæ§‹æˆã‚’ç¶­æŒã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

ä¸€æ–¹ã§ã€**å…¬é–‹éµã®è¨­å®šã¯äº‹å‰ã«ã‚„ã£ã¦ãŠãå¿…è¦ãŒã‚ã‚‹ã®ã§ã€éµç®¡ç†ã®å•é¡Œã¯è§£æ±ºã—ã¾ã›ã‚“ã€‚**
å…¬é–‹éµã¨ IAM ã§æ¨©é™ãŒ 2 é‡ç®¡ç†ã«ãªã£ã¦ã—ã¾ã†ã®ã‚‚ã‚¤ã‚±ã¦ãªã„ãƒã‚¤ãƒ³ãƒˆã§ã™ã€‚

### InstanceConnect

https://docs.aws.amazon.com/ja_jp/AWSEC2/latest/UserGuide/Connect-using-EC2-Instance-Connect.html
AWS ã«ã¯ [EC2 Instance Connect](https://docs.aws.amazon.com/ja_jp/AWSEC2/latest/UserGuide/Connect-using-EC2-Instance-Connect.html)ã¨ã„ã†ã‚µãƒ¼ãƒ“ã‚¹ã‚‚ã‚ã‚Šã¾ã™ã€‚
ã“ã¡ã‚‰ã¯ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹å†…(æ­£ç¢ºã«ã¯ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿)ã« 60 ç§’é–“æœ‰åŠ¹ãªä¸€æ™‚çš„ãª SSH å…¬é–‹éµã‚’ push ã—ã¦ãã‚Œã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã§ã™ã€‚
ã“ã¡ã‚‰ã‚‚äº‹å‰ã«ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹å†…ã« `ec2-instance-connect` ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãŠãå¿…è¦ãŒã‚ã‚Šã¾ã™ãŒã€æœ€æ–°ã® ubuntu/AmazonLinux ã«ã¯(ãŸã¶ã‚“)æœ€åˆã‹ã‚‰å…¥ã£ã¦ã„ã¾ã™ã€‚
å¿…è¦ãªæ¨©é™ã¯ `ec2-instance-connect:SendSSHPublicKey` ã§ã™ã€‚
ã“ã‚Œã‚’ä½¿ã†ã¨éµç®¡ç†ã‚’ã‹ã‚‰è„±å´ã§ãã‚‹ã®ã§ã€é‹ç”¨ãŒå˜ç´”åŒ–ã§ãã¾ã™ã€‚
ä¸€æ–¹ã§ã€**æ¥ç¶šè‡ªä½“ã¯é€šå¸¸ã® ssh ã‚’ä½¿ã†ã®ã§ã€ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ public subnet ã«é…ç½®ã—ã¦ãƒãƒ¼ãƒˆã‚’é–‹æ”¾ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚**
ã“ã®ç‚¹ã€SessionManager ã¨ä¸€é•·ä¸€çŸ­ã§ã™ã€‚

> ã¡ãªã¿ã«[ec2instanceconnectcli](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-instance-connect-set-up.html#ec2-instance-connect-install-eic-CLI)ã¨ã„ã†å…¬å¼ãƒ„ãƒ¼ãƒ«ã‚‚ã‚ã‚Šã¾ã™ãŒã€Python ä¾å­˜ãªã®ã¨ã€SessionManager ã¨ã®é€£æºãŒè€ƒæ…®ã•ã‚Œã¦ã„ãªã„ç‚¹ãŒæ¬ ç‚¹ã§ã™ã€‚

### SessionManager+InstanceConnect

ã‚ˆãè¦‹ã‚‹ã¨ã“ã® 2 ã¤ã®ã‚µãƒ¼ãƒ“ã‚¹ã¯ç›¸è£œçš„ãªã®ã§ã€çµ„ã¿åˆã‚ã›ãŸã‚‰ã ã„ãŸã„ã™ã¹ã¦ã®å•é¡ŒãŒè§£æ±ºã—ã¾ã™ã€‚
ã‚„ã£ã¦ã„ã‚‹ã“ã¨ã¯ã€ `InstanceConnectã§ä¸€æ™‚å…¬é–‹éµã‚’pushã—ã€SessionManagerã®ãƒˆãƒ³ãƒãƒ«ä¸‹ã§sshã™ã‚‹`ã ã‘ã§ã™ã€‚
ã©ã¡ã‚‰ã‚‚ IAM ã§æ¨©é™ç®¡ç†ã§ãã¾ã™ã€‚ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹å†…ã«ã¯ä¸€åˆ‡å…¬é–‹éµã‚’é…ç½®ã™ã‚‹å¿…è¦ãŒãªããªã‚Šã¾ã™ã€‚

# ã¾ã¨ã‚

çµ„ã¿åˆã‚ã›ãŸã‚‰ä¾¿åˆ©ï¼
(ãã‚‚ãã‚‚ EC2 ä½¿ã†é‹ç”¨ã‚’ã§ãã‚‹ã ã‘é¿ã‘ãŸã„ã¨ã“ã‚ã§ã¯ã‚ã‚‹)

# é–¢é€£è¨˜äº‹

https://qiita.com/sisisin/items/1cb6b79f729f1173eaba  
https://blog.youyo.io/posts/created-awssh-command-that-can-login-to-ec2-instance-securely/
